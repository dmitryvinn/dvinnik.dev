{"componentChunkName":"component---src-templates-article-index-js","path":"/articles/2022/media-messages-via-whatsapp/","result":{"data":{"markdownRemark":{"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQD/2gAMAwEAAhADEAAAAc2oGAR//8QAGBABAAMBAAAAAAAAAAAAAAAAAgEDERP/2gAIAQEAAQUCCkxXR0Czf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABoQAQABBQAAAAAAAAAAAAAAAAEAEiExUXH/2gAIAQEABj8CbCMqxqcn/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAERIUH/2gAIAQEAAT8hU/YUs4VuhsI+D//aAAwDAQACAAMAAAAQcD//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/EHiKf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQADAQEBAAAAAAAAAAAAAAEAESFhQcH/2gAIAQEAAT8QQIKh56VHaKWGtF2/K5LFhrLmLP/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cover\"\n        title=\"cover\"\n        src=\"/static/f3f9144dac43d8d8f9750c6c0c5410c7/212bf/cover.jpg\"\n        srcset=\"/static/f3f9144dac43d8d8f9750c6c0c5410c7/7809d/cover.jpg 192w,\n/static/f3f9144dac43d8d8f9750c6c0c5410c7/4ecad/cover.jpg 384w,\n/static/f3f9144dac43d8d8f9750c6c0c5410c7/212bf/cover.jpg 768w,\n/static/f3f9144dac43d8d8f9750c6c0c5410c7/5ef17/cover.jpg 1152w,\n/static/f3f9144dac43d8d8f9750c6c0c5410c7/c8ae0/cover.jpg 1279w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><em>By Dmitry Vinnik</em></p>\n<p><em>Originally posted <a href=\"https://business.whatsapp.com/blog/media-messages-via-app\">here</a>.</em></p>\n<p><strong>Prerequisites</strong></p>\n<p>To follow and understand the tutorial, you should have a basic knowledge of Node.js and Express.js applications. Additionally, ensure you’ve completed the basic steps in our guide to getting started in the WhatsApp documentation. If you’re a business solutions provider (BSP), follow our BSP guide and ensure your application passes the review process.</p>\n<p><strong>Make sure you have three items ready:</strong></p>\n<ul>\n<li>A WhatsApp Business ID.</li>\n<li>A phone number ID or test phone ID.</li>\n<li>Your system user token with required permissions below:</li>\n</ul>\n<p>If you’re eager to see the final application, you can check out the final project code.</p>\n<p><strong>Creating a Basic Application</strong></p>\n<p>For this demonstration, you’ll use this basic skeleton Node.js and Express.js server along with the necessary dependencies and skeleton functions already created.</p>\n<p>The tutorial also includes a request package to carry out HTTP requests as your application communicates with an API. There are two variables in the application’s .env file:</p>\n<p><code>META_AUTH_TOKEN and MESSAGING_PRODUCT</code></p>\n<p>After setting up the server, you can jump right into API creation.</p>\n<p>Before you can send any media-based messages using WhatsApp, you must upload media for WhatsApp to access later. Media files uploaded to WhatsApp persist for 30 days unless you delete them.</p>\n<p>You need to create a new POST route inside the routes/media.js file that you can use to manage your media. According to the documentation, you need to pass four items:</p>\n<ul>\n<li>Phone number ID, which you pass as a parameter.</li>\n<li>The file you want to upload, which you pass as form data.</li>\n<li>Upload file type, which you generate using the helper function.</li>\n<li>Messaging product, which you get from the .env file.</li>\n<li>When you create an API call, though, you only need a phone number ID and file. The remaining fields you generate using the helper functions.</li>\n</ul>\n<p>You use the npm package formidable to process the form data. Note that the WhatsApp Business API has some limitations on specific types and sizes, which you can find in the Supported Media Types section at the bottom of the Media documentation. There are two helper functions inside the helper/validations.js file in the skeleton project to cope with that.</p>\n<p>To upload an image, you need to initialize a new formidable form. Using the form object, parse the file and perform some validations using the helper functions. Next, perform a POST request with form data and a valid authentication token using the request.</p>\n<pre><code>exports.uploadMedia = async (req, res) => {\nlet form = new formidable.IncomingForm();\nform.keepExtensions = true;\nform.parse(req, async (err, fields, files) => {\nif (err) {\nreturn res.status(400).json({\nerror: \"Media could not be uploaded\",\n});\n}\nif (!files.file) {\nreturn res.status(400).json({\nerror: \"Media File is required\",\n});\n}\nlet isFileValidSize = validateMediaSize(files.file.size, files.file.type);\nif (!isFileValidSize) {\nreturn res.status(400).json({\nerror: `Media File size should be less than ${mediaLimits(\nfiles.file.type\n)}`,\n});\n}\nrequest.post(\n{\nurl: `https://graph.facebook.com/v13.0/${req.params.id}/media`,\nformData: {\nfile: {\nvalue: fs.createReadStream(files.file.path),\noptions: {\nfilename: files.file.name,\ncontentType: files.file.type,\n},\n},\ntype: files.file.type,\nmessaging_product: process.env.MESSAGING_PRODUCT,\n},\nheaders: {\nAuthorization: `Bearer ${process.env.META_AUTH_TOKEN}`,\n\"content-type\": \"multipart/form-data\",\n},\n},\nfunction (err, resp, body) {\nif (err) {\nconsole.log(\"Error!\");\n} else {\nres.json(JSON.parse(body));\n}\n}\n);\n});\n};\n</code></pre>\n<p>After adding this function, you can test this route using Postman. This is how the final object should look in Postman’s interface:</p>\n<p>Once you click Send, you get the upload media ID as a response from the API.</p>\n<p>Make note of the upload media ID as we’ll use it later in this tutorial. If you’re building an application with a data layer, you can store this ID in your database for later use. Or, your front-end application can store the ID temporarily in the variables or state.</p>\n<p><strong>Sending a Media Message</strong></p>\n<p>Now, use the media ID you retrieved in the previous step to send a media message to the customer. According to the API reference, you must send five items to the API to successfully send the media message to the customer:</p>\n<ul>\n<li>Phone number ID passed as parameters</li>\n<li>Customer phone number sent in the request body</li>\n<li>Type of media sent in the request body</li>\n<li>Media ID sent in the request body</li>\n<li>Recipient Type an individual in this case</li>\n</ul>\n<p>The function looks like this:</p>\n<pre><code>exports.sendMediaMessage = async (req, res) => {\nconst { id, to, type } = req.body;\nif (!id || !to || !type) {\nreturn res.status(400).json({\nerror: \"Required Fields: to, type and id\",\n});\n}\nrequest.post(\n{\nurl: `https://graph.facebook.com/v13.0/${req.params.id}/messages`,\nheaders: {\nAuthorization: `Bearer ${process.env.META_AUTH_TOKEN}`,\n\"content-type\": \"application/json\",\n},\nbody: `{\n\"messaging_product\": \"whatsapp\",\n\"recipient_type\": \"individual\",\n\"to\": \"${to}\",\n\"type\": \"${type}\",\n\"${type}\": {\n\"id\": \"${id}\",\n},\n}`,\n},\nfunction (err, resp, body) {\nif (err) {\nconsole.log(\"Error!\");\n} else {\nres.json(JSON.parse(body));\n}\n\n}\n\n);\n\n};\n</code></pre>\n<p>If you run this endpoint in Postman, with the necessary details and arguments, this is how it looks.</p>\n<p>After sending, you see the following output in Postman, which includes the message ID as well.</p>\n<p><strong>Viewing Media Items</strong></p>\n<p>Retrieving the media URL can be done easily with the GET operation and the fetched or stored media ID.</p>\n<pre><code>exports.getMediaUrl = async (req, res) => {\nrequest.get(\n{\nurl: `https://graph.facebook.com/v13.0/${req.params.id}`,\nheaders: {\nAuthorization: `Bearer ${process.env.META_AUTH_TOKEN}`,\n},\n},\n\nfunction (err, resp, body) {\nif (err) {\nconsole.log(\"Error!\");\n} else {\nres.json(JSON.parse(body));\n}\n}\n);\n};\n</code></pre>\n<p>This is how the Postman request and response looks after successfully fetching the media item.</p>\n<p><strong>Deleting Media</strong></p>\n<p>To delete media, you’ll use the same WhatsApp API endpoint for media requests with the DELETE operation.</p>\n<pre><code>exports.deleteMedia = async (req, res) => {\nrequest.delete(\n{\nurl: `https://graph.facebook.com/v13.0/${req.params.id}`,\nheaders: {\nAuthorization: `Bearer ${process.env.META_AUTH_TOKEN}`,\n},\n},\nfunction (err, resp, body) {\nif (err) {\nconsole.log(\"Error!\");\n} else {\nres.json(JSON.parse(body));\n}\n\n}\n\n);\n\n};\n</code></pre>\n<p>After the successful media deletion, the API sends the following response:</p>\n<p><strong>Learn More About the WhatsApp Business Platform</strong></p>\n<p>This tutorial is just one example of what you can do with the WhatsApp Business Platform. As you plan your next project, check out the WhatsApp Business Platform documentation for a full understanding of its media functionality and limitations.</p>\n<p>The WhatsApp Business Platform can provide opportunities to engage your customers using rich media messaging. Building an API-based application allows you to collect and build a media library that your users can leverage to send messages consistently and efficiently, reducing repetitive work.</p>\n<p>Check out the WhatsApp developer portal and start building your application today to see what else is available.</p>","frontmatter":{"title":"Sending WhatsApp Media Messages From An App","description":"We’ll use this basic skeleton Node.js and Express.js server along with the necessary dependencies and skeleton functions already created.","canonicalUrl":"https://business.whatsapp.com/blog/media-messages-via-app","date":"Jun 28, 2022"}}},"pageContext":{"slug":"/articles/2022/media-messages-via-whatsapp/","previous":{"fields":{"slug":"/articles/2022/meet-the-developers-mobile-edition-with-vadims/"},"frontmatter":{"title":"Meet the Developers: Mobile Edition (Vadims Savjolovs)"}},"next":{"fields":{"slug":"/articles/2022/steps-of-open-source-project-health/"},"frontmatter":{"title":"The 10,000 Steps of Open Source Project Health: Dmitry Vinnik [Testμ 2022]"}}}},"staticQueryHashes":["2125292342","2915660680","3649515864","63159454"]}